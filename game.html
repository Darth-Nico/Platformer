<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Unhallowed Parish - Chapter 1</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            font-family: 'Cormorant Garamond', serif;
            height: 100vh;
            color: #d4b886;
            overflow: hidden;
        }

        .game-container {
            width: 100vw;
            height: 100vh;
            background: url('assets/level1bg.png') no-repeat center center;
            background-size: cover;
            position: relative;
        }

        .interaction-point {
            position: absolute;
            width: 80px;
            height: 80px;
            border: 4px solid rgba(212, 184, 134, 0.7);
            border-radius: 50%;
            cursor: pointer;
            animation: pulse 2s infinite;
            background: rgba(212, 184, 134, 0.15);
            box-shadow: 0 0 30px rgba(212, 184, 134, 0.3);
        }

        @keyframes pulse {
            0% { 
                transform: scale(1); 
                opacity: 0.7;
                box-shadow: 0 0 30px rgba(212, 184, 134, 0.3);
            }
            50% { 
                transform: scale(1.3); 
                opacity: 1;
                box-shadow: 0 0 40px rgba(212, 184, 134, 0.5);
            }
            100% { 
                transform: scale(1); 
                opacity: 0.7;
                box-shadow: 0 0 30px rgba(212, 184, 134, 0.3);
            }
        }

        .dialogue-box {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 800px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(212, 184, 134, 0.3);
            padding: 2rem;
            color: #d4b886;
            font-size: 1.2rem;
            line-height: 1.6;
            display: none;
            z-index: 10;
        }

        .inventory {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 1rem;
            border: 1px solid rgba(212, 184, 134, 0.3);
        }

        .inventory-slot {
            width: 40px;
            height: 40px;
            border: 1px solid rgba(212, 184, 134, 0.3);
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 5px;
        }

        .inventory-slot img {
            width: 25px;
            height: 25px;
            object-fit: contain;
        }

        .stats {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 1rem;
            border: 1px solid rgba(212, 184, 134, 0.3);
        }

        .stat-bar {
            width: 200px;
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(212, 184, 134, 0.3);
            margin-top: 5px;
            margin-bottom: 10px;
        }

        .stat-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .health-fill { background: #963030; }
        .faith-fill { background: #4a90e2; }

        .hint {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 1rem;
            border: 1px solid rgba(212, 184, 134, 0.3);
            font-style: italic;
            max-width: 300px;
        }

        .character-dialogue {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 800px;
            display: flex;
            gap: 2rem;
            z-index: 10;
        }

        .dialogue-portrait {
            width: 150px;
            height: 200px;
            background: url('assets/main_character (talking bubble).png') no-repeat center;
            background-size: contain;
        }

        .dialogue-bubble {
            flex: 1;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(212, 184, 134, 0.3);
            padding: 1.5rem;
            color: #d4b886;
            font-size: 1.2rem;
            line-height: 1.6;
            position: relative;
        }

        .character-name {
            font-family: 'Cinzel', serif;
            font-size: 1.4rem;
            margin-bottom: 0.5rem;
            color: #d4b886;
        }

        .interaction-point img {
            width: 50px;
            height: 50px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.9;
            filter: drop-shadow(0 0 8px rgba(212, 184, 134, 0.5));
        }

        .inventory.hidden {
            display: none;
        }

        .pause-menu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            padding: 3rem;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(212, 184, 134, 0.3);
            backdrop-filter: blur(5px);
            border-radius: 4px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            z-index: 100;
            display: none;
        }

        .pause-menu h1 {
            font-family: 'Cinzel', serif;
            font-size: 3rem;
            margin-bottom: 2rem;
            text-shadow: 0 0 10px rgba(212, 184, 134, 0.3),
                         2px 2px 4px rgba(0, 0, 0, 0.5);
            letter-spacing: 6px;
            color: #d4b886;
        }

        .pause-menu .menu {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            min-width: 300px;
        }

        .pause-menu .menu-item {
            font-size: 1.8rem;
            color: #d4b886;
            text-decoration: none;
            padding: 1rem 2rem;
            border: 1px solid rgba(212, 184, 134, 0.3);
            transition: all 0.4s ease;
            position: relative;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 3px;
            background: linear-gradient(to right, rgba(212, 184, 134, 0.1) 50%, transparent 50%);
            background-size: 200% 100%;
            background-position: right bottom;
        }

        .pause-menu .menu-item::before,
        .pause-menu .menu-item::after {
            content: '❈';
            position: absolute;
            font-size: 1.2rem;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .pause-menu .menu-item::before {
            left: 10px;
        }

        .pause-menu .menu-item::after {
            right: 10px;
        }

        .pause-menu .menu-item:hover {
            background-position: left bottom;
            border-color: rgba(212, 184, 134, 0.8);
            text-shadow: 0 0 10px rgba(212, 184, 134, 0.5);
        }

        .pause-menu .menu-item:hover::before,
        .pause-menu .menu-item:hover::after {
            opacity: 1;
        }

        .inventory-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 800px;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid rgba(212, 184, 134, 0.5);
            padding: 2rem;
            z-index: 100;
            display: none;
        }

        .inventory-modal-title {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            text-align: center;
            margin-bottom: 2rem;
            color: #d4b886;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .inventory-item {
            width: 100%;
            aspect-ratio: 1;
            border: 1px solid rgba(212, 184, 134, 0.3);
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
        }

        .inventory-item img {
            width: 60%;
            height: 60%;
            object-fit: contain;
        }

        .item-description {
            position: absolute;
            bottom: -80px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(212, 184, 134, 0.3);
            padding: 1rem;
            font-size: 0.9rem;
            display: none;
            z-index: 5;
        }

        .inventory-item:hover .item-description {
            display: block;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 30px;
            height: 30px;
            border: 1px solid rgba(212, 184, 134, 0.3);
            background: transparent;
            color: #d4b886;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(212, 184, 134, 0.1);
            border-color: rgba(212, 184, 134, 0.8);
        }

        .inventory-item.empty {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .empty-slot {
            color: rgba(212, 184, 134, 0.3);
            font-style: italic;
            font-size: 0.9rem;
        }

        .skip-dialogue {
            position: absolute;
            right: 1rem;
            bottom: 1rem;
            width: 30px;
            height: 30px;
            border: 1px solid rgba(212, 184, 134, 0.3);
            background: transparent;
            color: #d4b886;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .skip-dialogue:hover {
            background: rgba(212, 184, 134, 0.1);
            border-color: rgba(212, 184, 134, 0.8);
        }

        .settings-menu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid rgba(212, 184, 134, 0.5);
            padding: 2rem;
            z-index: 100;
            display: none;
        }

        .settings-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 2rem;
            margin-bottom: 3rem;
        }

        .setting-item {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .custom-checkbox {
            position: relative;
            width: 50px;
            height: 26px;
            cursor: pointer;
        }

        .custom-checkbox input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .checkbox-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(212, 184, 134, 0.3);
            transition: 0.4s;
            border-radius: 34px;
        }

        .checkbox-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: #d4b886;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .checkbox-slider {
            background: rgba(212, 184, 134, 0.2);
            border-color: rgba(212, 184, 134, 0.8);
        }

        input:checked + .checkbox-slider:before {
            transform: translateX(24px);
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .volume-slider {
            -webkit-appearance: none;
            width: 200px;
            height: 4px;
            background: rgba(212, 184, 134, 0.2);
            border: 1px solid rgba(212, 184, 134, 0.3);
            border-radius: 2px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #d4b886;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .setting-label {
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            color: #d4b886;
        }

        .settings-menu h1 {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            text-align: center;
            color: #d4b886;
            margin-bottom: 2rem;
        }

        .settings-menu .menu-item {
            display: block;
            width: 200px;
            margin: 1rem auto;
            padding: 0.8rem;
            background: transparent;
            border: 1px solid rgba(212, 184, 134, 0.3);
            color: #d4b886;
            font-family: 'Cinzel', serif;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .settings-menu .menu-item:hover {
            background: rgba(212, 184, 134, 0.1);
            border-color: rgba(212, 184, 134, 0.8);
        }

        .dark-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            transition: opacity 2s ease;
            pointer-events: none;
        }

        .dialogue-card {
            position: fixed;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 70%;
            max-width: 800px;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid rgba(212, 184, 134, 0.5);
            padding: 1.5rem;
            display: flex;
            gap: 1.5rem;
            z-index: 10;
        }

        .dialogue-portrait {
            width: 180px;
            height: 250px;
            background: url('assets/main_character (talking bubble).png') no-repeat center;
            background-size: contain;
        }

        .hint-close {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            border: 1px solid rgba(212, 184, 134, 0.3);
            background: transparent;
            color: #d4b886;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .hint-close:hover {
            background: rgba(212, 184, 134, 0.1);
            border-color: rgba(212, 184, 134, 0.8);
        }

        .inventory-button {
            position: fixed;
            bottom: 20px;
            right: 40%;
            width: 50px;
            height: 50px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(212, 184, 134, 0.3);
            color: #d4b886;
            font-family: 'Cinzel', serif;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .inventory-button:hover {
            background: rgba(212, 184, 134, 0.1);
            border-color: rgba(212, 184, 134, 0.8);
        }

        .inventory-button img {
            width: 35px;
            height: 35px;
            opacity: 0.8;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .shake {
            animation: shake 0.3s ease-in-out;
        }

        .tome-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .tome-content {
            background: rgba(20, 12, 8, 0.98);
            border: 3px solid #8b6b4a;
            padding: 2.5rem;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            color: #d4b886;
            font-family: 'Cormorant Garamond', serif;
            position: relative;
            background-image: url('assets/parchment_texture.png');
            box-shadow: 0 0 30px rgba(139, 107, 74, 0.2);
        }

        .tome-content::-webkit-scrollbar {
            width: 12px;
        }

        .tome-content::-webkit-scrollbar-track {
            background: rgba(20, 12, 8, 0.9);
            border: 1px solid #8b6b4a;
        }

        .tome-content::-webkit-scrollbar-thumb {
            background: #8b6b4a;
            border-radius: 6px;
            border: 2px solid rgba(20, 12, 8, 0.9);
        }

        .tome-content::-webkit-scrollbar-thumb:hover {
            background: #a17e59;
        }

        .tome-content h2 {
            font-family: 'Cinzel', serif;
            font-size: 2.2rem;
            text-align: center;
            margin-bottom: 2.5rem;
            color: #c4a062;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            border-bottom: 2px solid rgba(139, 107, 74, 0.5);
            padding-bottom: 1rem;
        }

        .tome-text {
            font-size: 1.3rem;
            line-height: 1.8;
            color: #c4a062;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .tome-text p {
            margin-bottom: 1.8rem;
        }

        .tome-text em {
            display: block;
            text-align: right;
            font-style: italic;
            margin-top: 3rem;
            color: #8b6b4a;
        }

        .close-tome {
            display: block;
            margin: 2.5rem auto 0;
            padding: 1rem 2.5rem;
            background: rgba(139, 107, 74, 0.1);
            border: 2px solid #8b6b4a;
            color: #c4a062;
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-tome:hover {
            background: rgba(139, 107, 74, 0.2);
            border-color: #a17e59;
            text-shadow: 0 0 10px rgba(196, 160, 98, 0.5);
        }

        .continue-button {
            position: fixed;
            bottom: 40px;
            right: 40px;
            padding: 1rem 2rem;
            font-family: 'Cinzel', serif;
            font-size: 1.4rem;
            color: #d4b886;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid rgba(212, 184, 134, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
            display: none;
        }

        .continue-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chapter-transition {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            opacity: 0;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 2s ease;
        }

        .chapter-text {
            font-family: 'Cinzel', serif;
            font-size: 3rem;
            color: #808080;
            opacity: 0;
            transition: opacity 2s ease;
        }

        .continue-button:hover {
            background: rgba(212, 184, 134, 0.1);
            border-color: rgba(212, 184, 134, 0.8);
            text-shadow: 0 0 10px rgba(212, 184, 134, 0.5);
        }

        /* Add this style for chapter 2 */
        .game-container.chapter2 {
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), 
                        url('assets/alien_field.png') no-repeat center center;
            background-size: cover;
            filter: grayscale(100%);
        }

        .light-source {
            position: absolute;
            top: 20%;
            left: 10%;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, #fff9c4 0%, #ffd54f 50%, #ff9800 100%);
            border-radius: 50%;
            box-shadow: 0 0 30px #ffd54f;
        }

        .light-target {
            position: absolute;
            top: 70%;
            right: 10%;
            width: 60px;
            height: 60px;
            border: 3px solid #d4b886;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .light-shard {
            position: absolute;
            width: 120px;
            height: 6px;
            background: rgba(212, 184, 134, 0.9);
            cursor: pointer;
            transform-origin: center;
            transition: transform 0.3s ease, border 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
        }

        .light-shard:hover {
            background: rgba(212, 184, 134, 1);
            box-shadow: 0 0 15px rgba(212, 184, 134, 0.5);
        }

        .light-shard.correct {
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8),
                        0 0 40px rgba(255, 255, 255, 0.6),
                        0 0 60px rgba(255, 255, 255, 0.4);
            border: none !important;
        }

        .light-beam {
            position: absolute;
            height: 2px;
            background: linear-gradient(to right, rgba(255, 244, 179, 0.7), rgba(255, 213, 79, 0.7));
            transform-origin: left;
            pointer-events: none;
        }

        /* Update the final beam style */
        .light-beam.final {
            height: 6px;  /* Thicker than normal beams */
            background: linear-gradient(to right, 
                rgba(255, 255, 255, 1),
                rgba(255, 244, 179, 0.9)
            );
            box-shadow: 
                0 0 15px rgba(255, 255, 255, 0.9),
                0 0 30px rgba(255, 244, 179, 0.7);
            animation: finalBeamPulse 1.5s infinite;
        }

        @keyframes finalBeamPulse {
            0% { 
                opacity: 0.8;
                height: 6px;
            }
            50% { 
                opacity: 1;
                height: 8px;
            }
            100% { 
                opacity: 0.8;
                height: 6px;
            }
        }

        /* Add this style for the completion message */
        .completion-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid rgba(212, 184, 134, 0.8);
            padding: 2rem;
            color: #d4b886;
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            text-align: center;
            z-index: 100;
            animation: fadeIn 1s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="dark-overlay"></div>
        
        <!-- Only show candle initially -->
        <div class="interaction-point" style="top: 40%; left: 30%;" 
             data-description="In this darkness, I can barely make out the shape of a candle on what must be the altar..."
             data-item="candle"
             data-name="Blessed Candle">
            <img src="assets/candle.png" alt="Candle">
        </div>
        
        <!-- Hidden initially -->
        <div class="interaction-point" style="top: 35%; left: 70%; display: none;" 
             data-description="A golden key glints in the candlelight... it seems to radiate with an otherworldly energy."
             data-item="golden_key"
             data-name="Golden Key">
            <img src="assets/golden_key.png" alt="Golden Key">
        </div>

        <!-- Add the chest interaction point -->
        <div class="interaction-point" style="top: 60%; left: 50%;" 
             data-description="An ornate chest, its golden lock gleaming in the dim light."
             data-item="chest"
             data-name="Mysterious Chest">
            <img src="assets/chest_closed.png" alt="Chest">
        </div>
    </div>

    <div class="stats">
        <div>Health</div>
        <div class="stat-bar">
            <div class="stat-fill health-fill" style="width: 100%"></div>
        </div>
        <div>Faith</div>
        <div class="stat-bar">
            <div class="stat-fill faith-fill" style="width: 100%"></div>
        </div>
    </div>

    <div class="inventory">
        <div class="inventory-slot" data-item="empty"></div>
        <div class="inventory-slot" data-item="empty"></div>
        <div class="inventory-slot" data-item="empty"></div>
        <div class="inventory-slot" data-item="empty"></div>
    </div>

        <button class="inventory-button" onclick="toggleInventoryModal()" title="Open Inventory (E)">
            <img src="assets/backpack-icon.png" alt="Inventory">
        </button>

    <div class="hint">
        <button class="hint-close">&times;</button>
        Click on glowing points to investigate. Press 'E' to open inventory, 'Space' to use items.
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Check current chapter
            const currentChapter = localStorage.getItem('currentChapter') || '1';

            // Show chapter animation
            const transition = document.createElement('div');
            transition.className = 'chapter-transition';
            transition.style.opacity = '1';

            const chapterText = document.createElement('div');
            chapterText.className = 'chapter-text';
            chapterText.textContent = `Chapter ${currentChapter}`;
            chapterText.style.opacity = '0';

            transition.appendChild(chapterText);
            document.body.appendChild(transition);
            
            // Show chapter text
            setTimeout(() => {
                chapterText.style.opacity = '1';
            }, 1000);
            
            // Fade out everything
            setTimeout(() => {
                transition.style.opacity = '0';
                // Remove after fade and initialize correct chapter
                setTimeout(() => {
                    transition.remove();
                    if (currentChapter === '2') {
                        // Remove chapter 1 elements
                        document.querySelectorAll('.interaction-point').forEach(point => point.remove());
                        // Initialize chapter 2
                        initializeChapter2();
                    }
                    // Chapter 1 elements are already in the HTML by default
                }, 2000);
            }, 3000);

            // Add this at the top of the script
            let hasReadTome = false;
            
            // Create audio elements
            const gameMusic = new Audio('ASSETS/the_unhallowed_parish_main_theme.mp3');
            const soundtrack1 = new Audio('ASSETS/soundtrack1.mp3');
            const soundtrack2 = new Audio('ASSETS/soundtrack2.mp3');
            
            let currentTrack = 0;
            const tracks = [gameMusic, soundtrack1, soundtrack2];
            
            // Set up track sequence with random selection
            tracks.forEach(track => {
                track.addEventListener('ended', () => {
                    // Get array of possible next tracks (excluding current)
                    const possibleTracks = tracks.filter((_, index) => index !== currentTrack);
                    
                    // Randomly select one of the remaining tracks
                    const randomIndex = Math.floor(Math.random() * possibleTracks.length);
                    currentTrack = tracks.indexOf(possibleTracks[randomIndex]);
                    const nextTrack = tracks[currentTrack];
                    
                    // Apply current volume settings
                    if (settings?.musicEnabled) {
                        nextTrack.volume = window.globalVolume;
                        nextTrack.play().catch(err => console.log('Playback prevented:', err));
                    }
                });
            });

            // Start with first track
            window.addEventListener('click', () => {
                if (gameMusic.paused && settings?.musicEnabled) {
                    gameMusic.volume = window.globalVolume;
                    gameMusic.play().catch(err => {
                        console.log('Playback prevented:', err);
                    });
                }
            }, { once: true });

            // Handle music on tab focus/blur
            window.addEventListener('focus', () => {
                const currentAudio = tracks[currentTrack];
                if (settings?.musicEnabled) {
                    currentAudio.play().catch(err => {
                        console.log('Autoplay prevented:', err);
                    });
                }
            });

            window.addEventListener('blur', () => {
                tracks[currentTrack].pause();
            });

            const dialogueBox = document.querySelector('.dialogue-box');
            const interactionPoints = document.querySelectorAll('.interaction-point');
            const inventorySlots = document.querySelectorAll('.inventory-slot');
            let currentDialogue = null;

            // Handle interaction points
            interactionPoints.forEach(point => {
                point.addEventListener('click', () => {
                    if (point.dataset.item === 'chest') {
                        const hasKey = Array.from(document.querySelectorAll('.inventory-slot'))
                            .some(slot => slot.dataset.item === 'golden_key');
                        
                        if (!hasKey) {
                            point.classList.add('shake');
                            setTimeout(() => point.classList.remove('shake'), 300);
                            showDialogue("Locked... I'll need to find the key first.");
                            return;
                        }
                    }
                    
                    showDialogue(point.dataset.description);
                    if (point.dataset.item && point.dataset.item !== 'chest') {
                        addToInventory(point.dataset.item, point.dataset.name);
                        point.remove();
                        createCollectSound();
                    }
                });
            });

            function showDialogue(text) {
                clearTimeout(currentDialogue);
                
                const existingDialogue = document.querySelector('.dialogue-card');
                if (existingDialogue) {
                    existingDialogue.remove();
                }

                const dialogueElement = document.createElement('div');
                dialogueElement.className = 'dialogue-card';
                dialogueElement.innerHTML = `
                    <div class="dialogue-portrait"></div>
                    <div class="dialogue-bubble">
                        <div class="character-name">David</div>
                        ${text}
                        <button class="skip-dialogue">→</button>
                    </div>
                `;
                document.body.appendChild(dialogueElement);

                const skipBtn = dialogueElement.querySelector('.skip-dialogue');
                skipBtn.addEventListener('click', () => {
                    dialogueElement.remove();
                    clearTimeout(currentDialogue);
                });

                currentDialogue = setTimeout(() => {
                    dialogueElement.remove();
                }, 5000);
            }

            function addToInventory(itemName, itemDisplayName) {
                const emptySlot = document.querySelector('.inventory-slot[data-item="empty"]');
                if (emptySlot) {
                    emptySlot.dataset.item = itemName;
                    emptySlot.dataset.name = itemDisplayName;
                    emptySlot.innerHTML = `<img src="assets/${itemName}.png" alt="${itemDisplayName}">`;
                    
                    createPickupSound();
                    
                    if (itemName === 'candle') {
                        showDialogue("This candle might help me see what's lurking in the darkness...");
                    }
                    if (itemName === 'golden_key') {
                        showDialogue("A key... there must be something worth locking away in here.");
                    }
                } else {
                    showDialogue("I can't carry anything else.");
                }
            }

            function createCollectSound() {
                if (!window.soundEnabled) return;
                
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.3);
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3 * window.globalVolume, audioContext.currentTime + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.01 * window.globalVolume, audioContext.currentTime + 0.3);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.3);
            }

            // Add these variables
            const inventory = document.querySelector('.inventory');
            let selectedSlot = null;
            let isPaused = false;

            // Create pause menu
            const pauseMenu = document.createElement('div');
            pauseMenu.className = 'pause-menu';
            pauseMenu.innerHTML = `
                <h1>Paused</h1>
                <div class="menu">
                    <a class="menu-item" onclick="resumeGame()">Resume</a>
                    <a class="menu-item" onclick="window.openSettings()">Settings</a>
                    <a class="menu-item" onclick="window.location.href='index.html'">Return to Menu</a>
                </div>
            `;
            document.body.appendChild(pauseMenu);

            // Add the settings menu HTML
            const settingsMenu = document.createElement('div');
            settingsMenu.className = 'settings-menu';
            settingsMenu.style.display = 'none';
            settingsMenu.innerHTML = `
                <h1>Settings</h1>
                <div class="settings-container">
                    <div class="setting-item">
                        <label class="custom-checkbox">
                            <input type="checkbox" id="musicToggle" checked>
                            <span class="checkbox-slider"></span>
                        </label>
                        <span class="setting-label">Background Music</span>
                    </div>
                    <div class="volume-control">
                        <span class="setting-label">Volume</span>
                        <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="40">
                    </div>
                    <div class="setting-item">
                        <label class="custom-checkbox">
                            <input type="checkbox" id="soundToggle" checked>
                            <span class="checkbox-slider"></span>
                        </label>
                        <span class="setting-label">Sound Effects</span>
                    </div>
                </div>
                <div class="menu">
                    <button class="menu-item back-to-pause">Back</button>
                </div>
            `;
            document.body.appendChild(settingsMenu);

            // Update keyboard controls
            document.addEventListener('keydown', (e) => {
                if (isPaused && e.key !== 'Escape') return;

                switch(e.key) {
                    case 'e':
                    case 'E':
                        toggleInventoryModal();
                        break;
                    case ' ':
                        if (selectedSlot && selectedSlot.dataset.item !== 'empty') {
                            useItem(selectedSlot.dataset.item, selectedSlot.dataset.name);
                        }
                        break;
                    case 'Escape':
                        togglePause();
                        break;
                }
            });

            // Add these functions
            function togglePause() {
                isPaused = !isPaused;
                pauseMenu.style.display = isPaused ? 'block' : 'none';
                if (isPaused && gameMusic.volume > 0) {
                    gameMusic.volume = window.globalVolume * 0.1;
                } else if (!isPaused && settings?.musicEnabled) {
                    gameMusic.volume = window.globalVolume;
                }
            }

            window.resumeGame = function() {
                togglePause();
            }

            function useItem(itemName, itemDisplayName) {
                if (itemName === 'candle') {
                    createUseItemSound();
                    showDialogue("Dear Lord... what happened to this place while I was gone?");
                    
                    const overlay = document.querySelector('.dark-overlay');
                    overlay.style.opacity = '0';
                    
                    setTimeout(() => {
                        const keyPoint = document.querySelector('.interaction-point[data-item="golden_key"]');
                        keyPoint.style.display = 'block';
                    }, 2000);
                    
                    selectedSlot.dataset.item = 'empty';
                    selectedSlot.innerHTML = '';
                    selectedSlot.style.border = '1px solid rgba(212, 184, 134, 0.3)';
                    selectedSlot = null;
                }
                else if (itemName === 'golden_key') {
                    const chest = document.querySelector('.interaction-point[data-item="chest"]');
                    if (chest) {
                        createUseItemSound();
                        showDialogue("It fits... what secrets have they been keeping here?");
                        chest.querySelector('img').src = 'assets/chest_opened.png';
                        
                        selectedSlot.dataset.item = 'empty';
                        selectedSlot.innerHTML = '';
                        selectedSlot.style.border = '1px solid rgba(212, 184, 134, 0.3)';
                        selectedSlot = null;
                        
                        setTimeout(() => {
                            showDialogue("A tome... these pages... this can't be right...");
                            addToInventory('tome', 'Ancient Tome');
                            chest.remove();
                            
                            // Add continue button
                            const continueBtn = document.createElement('button');
                            continueBtn.className = 'continue-button' + (!hasReadTome ? ' disabled' : '');
                            continueBtn.textContent = 'Continue';
                            document.body.appendChild(continueBtn);
                            continueBtn.style.display = 'block';
                            
                            continueBtn.addEventListener('click', () => {
                                if (!hasReadTome) return;
                                
                                // Create chapter transition
                                const transition = document.createElement('div');
                                transition.className = 'chapter-transition';
                                
                                const chapterText = document.createElement('div');
                                chapterText.className = 'chapter-text';
                                chapterText.textContent = 'Chapter 2';
                                
                                transition.appendChild(chapterText);
                                document.body.appendChild(transition);
                                
                                // Fade to black
                                setTimeout(() => {
                                    transition.style.opacity = '1';
                                }, 100);
                                
                                // Show chapter text
                                setTimeout(() => {
                                    chapterText.style.opacity = '1';
                                }, 2000);
                                
                                // Update chapter in localStorage and reset game state
                                setTimeout(() => {
                                    localStorage.setItem('currentChapter', '2');
                                    // Reset game state for chapter 2
                                    document.querySelector('.dark-overlay').style.opacity = '1';
                                    // Remove existing items and interactions
                                    document.querySelectorAll('.interaction-point').forEach(point => point.remove());
                                    document.querySelectorAll('.inventory-slot').forEach(slot => {
                                        slot.dataset.item = 'empty';
                                        slot.innerHTML = '';
                                    });
                                    // Remove continue button
                                    continueBtn.remove();
                                    // Remove transition after fade
                                    setTimeout(() => {
                                        transition.style.opacity = '0';
                                        setTimeout(() => {
                                            transition.remove();
                                            // Here you would initialize chapter 2 content
                                            initializeChapter2();
                                        }, 2000);
                                    }, 2000);
                                }, 5000);
                            });
                        }, 1500);
                    }
                }
                else if (itemName === 'tome') {
                    createUseItemSound();
                    
                    const tomeModal = document.createElement('div');
                    tomeModal.className = 'tome-modal';
                    tomeModal.innerHTML = `
                        <div class="tome-content">
                            <h2>The Sacred Teachings of Light</h2>
                            <div class="tome-text">
                                <p>In the darkest corners of our sacred halls lies a truth known only to those who guard it. The divine light we wield is more than mere illumination - it is a weapon against the corruption that seeks to claim our souls.</p>
                                
                                <p>Through my studies, I have discovered that these entities, these parasites of faith, recoil from properly focused light. But mere candlelight is not enough. One must learn to manipulate the sacred geometry of light itself.</p>
                                
                                <p>The puzzles our forebears built into these halls are not mere decorations. They are tests - trials that require the proper manipulation of light to overcome. Mirrors, prisms, and blessed crystals must be aligned with purpose and precision.</p>
                                
                                <p>To any who find this tome: The path forward requires understanding of these divine mechanics. Use the blessed candles to reveal the hidden. Align the mirrors to direct the light. Only by mastering these principles can you hope to cleanse what lurks in these hallowed halls.</p>
                                
                                <p>May God grant you the wisdom to see, and the strength to face what the light reveals.</p>
                                
                                <em>- Father Michael</em>
                            </div>
                            <button class="close-tome">Close</button>
                        </div>
                    `;
                    
                    document.body.appendChild(tomeModal);
                    
                    const closeBtn = tomeModal.querySelector('.close-tome');
                    closeBtn.addEventListener('click', () => {
                        tomeModal.remove();
                        hasReadTome = true;
                        const continueBtn = document.querySelector('.continue-button');
                        if (continueBtn) {
                            continueBtn.classList.remove('disabled');
                        }
                    });
                }
            }

            // Update inventory interactions
            inventorySlots.forEach(slot => {
                slot.addEventListener('click', () => {
                    if(slot.dataset.item !== 'empty') {
                        if (selectedSlot === slot) {
                            slot.style.border = '1px solid rgba(212, 184, 134, 0.3)';
                            selectedSlot = null;
                        } else {
                            if (selectedSlot) {
                                selectedSlot.style.border = '1px solid rgba(212, 184, 134, 0.3)';
                            }
                            slot.style.border = '2px solid #d4b886';
                            selectedSlot = slot;
                        }
                    }
                });
            });

            // Add item descriptions object
            const itemDescriptions = {
                'candle': {
                    name: 'Blessed Candle',
                    description: 'A consecrated candle from the altar. Its flame burns with unusual intensity, useful for revealing hidden truths or warding off dark entities.'
                },
                'golden_key': {
                    name: 'Golden Key',
                    description: 'An ornate golden key emanating with divine energy. Its presence suggests the existence of a sacred door or container.'
                },
                'tome': {
                    name: 'Ancient Tome',
                    description: 'A weathered tome bound in leather, its pages filled with cryptic writings about manipulating divine light.'
                }
            };

            // Update the E key handler
            window.toggleInventoryModal = function() {
                const existingModal = document.querySelector('.inventory-modal');
                if (existingModal) {
                    // Update the inventory grid content before showing/hiding
                    const inventoryGrid = existingModal.querySelector('.inventory-grid');
                    inventoryGrid.innerHTML = Array.from(document.querySelectorAll('.inventory-slot')).map(slot => {
                        if (slot.dataset.item === 'empty') {
                            return `
                                <div class="inventory-item empty">
                                    <span class="empty-slot">Empty</span>
                                </div>
                            `;
                        }
                        return `
                            <div class="inventory-item" data-item="${slot.dataset.item}">
                                <img src="${slot.querySelector('img').src}" alt="${slot.dataset.name}">
                                <div class="item-description">
                                    <strong>${itemDescriptions[slot.dataset.item]?.name || slot.dataset.name}</strong><br>
                                    ${itemDescriptions[slot.dataset.item]?.description || 'No description available.'}
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    existingModal.style.display = existingModal.style.display === 'none' ? 'block' : 'none';
                    return;
                }

                const modal = document.createElement('div');
                modal.className = 'inventory-modal';
                modal.innerHTML = `
                    <button class="modal-close">×</button>
                    <div class="inventory-modal-title">Inventory</div>
                    <div class="inventory-grid">
                        ${Array.from(document.querySelectorAll('.inventory-slot')).map(slot => {
                            if (slot.dataset.item === 'empty') {
                                return `
                                    <div class="inventory-item empty">
                                        <span class="empty-slot">Empty</span>
                                    </div>
                                `;
                            }
                            return `
                                <div class="inventory-item" data-item="${slot.dataset.item}">
                                    <img src="${slot.querySelector('img').src}" alt="${slot.dataset.name}">
                                    <div class="item-description">
                                        <strong>${itemDescriptions[slot.dataset.item]?.name || slot.dataset.name}</strong><br>
                                        ${itemDescriptions[slot.dataset.item]?.description || 'No description available.'}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
                document.body.appendChild(modal);

                const closeBtn = modal.querySelector('.modal-close');
                closeBtn.addEventListener('click', () => {
                    modal.style.display = 'none';
                });
            };

            const settings = JSON.parse(localStorage.getItem('gameSettings'));
            if (settings) {
                const volume = settings.volume;
                window.globalVolume = volume;
                window.soundEnabled = settings.soundEnabled;
                
                // Apply music settings
                if (settings.musicEnabled) {
                    gameMusic.volume = volume;
                    gameMusic.play().catch(err => console.log('Autoplay prevented:', err));
                } else {
                    gameMusic.volume = 0;
                    gameMusic.pause();
                }

                // Listen for settings changes
                window.addEventListener('storage', (e) => {
                    if (e.key === 'gameSettings') {
                        const newSettings = JSON.parse(e.newValue);
                        window.globalVolume = newSettings.volume;
                        window.soundEnabled = newSettings.soundEnabled;
                        
                        if (newSettings.musicEnabled) {
                            gameMusic.volume = newSettings.volume;
                            gameMusic.play().catch(err => console.log('Autoplay prevented:', err));
                        } else {
                            gameMusic.volume = 0;
                            gameMusic.pause();
                        }
                    }
                });
            }

            // Add these functions
            window.openSettings = function() {
                pauseMenu.style.display = 'none';
                settingsMenu.style.display = 'block';
                
                // Load current settings
                const settings = JSON.parse(localStorage.getItem('gameSettings'));
                if (settings) {
                    document.getElementById('musicToggle').checked = settings.musicEnabled;
                    document.getElementById('soundToggle').checked = settings.soundEnabled;
                    document.getElementById('volumeSlider').value = settings.volume * 100;
                }
            }

            document.querySelector('.back-to-pause').addEventListener('click', () => {
                settingsMenu.style.display = 'none';
                pauseMenu.style.display = 'block';
            });

            // Add settings controls
            document.getElementById('musicToggle').addEventListener('change', (e) => {
                if (e.target.checked) {
                    gameMusic.volume = document.getElementById('volumeSlider').value / 100;
                    gameMusic.play().catch(err => console.log('Autoplay prevented:', err));
                } else {
                    gameMusic.volume = 0;
                    gameMusic.pause();
                }
                saveSettings();
            });

            document.getElementById('soundToggle').addEventListener('change', (e) => {
                window.soundEnabled = e.target.checked;
                saveSettings();
            });

            document.getElementById('volumeSlider').addEventListener('input', (e) => {
                const volume = e.target.value / 100;
                if (document.getElementById('musicToggle').checked) {
                    gameMusic.volume = volume;
                }
                window.globalVolume = volume;
                saveSettings();
            });

            function saveSettings() {
                const settings = {
                    musicEnabled: document.getElementById('musicToggle').checked,
                    soundEnabled: document.getElementById('soundToggle').checked,
                    volume: document.getElementById('volumeSlider').value / 100
                };
                localStorage.setItem('gameSettings', JSON.stringify(settings));
            }

            document.querySelector('.hint-close').addEventListener('click', () => {
                document.querySelector('.hint').style.display = 'none';
            });

            // Add these sound effect functions
            function createPickupSound() {
                if (!window.soundEnabled) return;
                
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.2);
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.2 * window.globalVolume, audioContext.currentTime + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.01 * window.globalVolume, audioContext.currentTime + 0.2);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.2);
            }

            function createUseItemSound() {
                if (!window.soundEnabled) return;
                
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator1 = audioContext.createOscillator();
                const oscillator2 = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator1.connect(gainNode);
                oscillator2.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator1.type = 'sine';
                oscillator2.type = 'triangle';
                
                oscillator1.frequency.setValueAtTime(300, audioContext.currentTime);
                oscillator2.frequency.setValueAtTime(600, audioContext.currentTime);
                oscillator1.frequency.linearRampToValueAtTime(600, audioContext.currentTime + 0.3);
                oscillator2.frequency.linearRampToValueAtTime(900, audioContext.currentTime + 0.3);
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.15 * window.globalVolume, audioContext.currentTime + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.01 * window.globalVolume, audioContext.currentTime + 0.3);
                
                oscillator1.start();
                oscillator2.start();
                oscillator1.stop(audioContext.currentTime + 0.3);
                oscillator2.stop(audioContext.currentTime + 0.3);
            }

            // Add function to initialize chapter 2
            function initializeChapter2() {
                const gameContainer = document.querySelector('.game-container');
                gameContainer.classList.add('chapter2');
                gameContainer.style.background = 'black';  // Pure black background
                
                // Keep dark overlay fully opaque
                const darkOverlay = document.querySelector('.dark-overlay');
                darkOverlay.style.opacity = '1';
                
                // Remove all existing elements
                document.querySelectorAll('.light-source, .light-target, .light-shard, .light-beam').forEach(el => el.remove());
                
                // Update hint text
                const hint = document.querySelector('.hint');
                hint.style.display = 'none';  // Hide hint for now
            }
        });
    </script>
</body>
</html> 